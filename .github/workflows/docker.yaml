name: Docker Pusher ğŸ³âœ¨

on:
  workflow_dispatch:
  schedule:
    - cron: '00 00 * * *'

env:
  ALIYUN_REGISTRY: "${{ secrets.ALIYUN_REGISTRY }}"
  ALIYUN_NAME_SPACE: "${{ secrets.ALIYUN_NAME_SPACE }}"
  ALIYUN_REGISTRY_USER: "${{ secrets.ALIYUN_REGISTRY_USER }}"
  ALIYUN_REGISTRY_PASSWORD: "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"

jobs:
  build:
    name: Pull & Push ğŸš€
    runs-on: ubuntu-latest

    steps:
    - name: Check Disk Before Cleanup ğŸ“¦
      run: |
        echo "ğŸ§¹ Before cleaning up..."
        df -hT

    - name: Maximize Disk Space ğŸ“ˆ
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 2048
        swap-size-mb: 128
        remove-dotnet: true
        remove-haskell: true
        build-mount-path: '/var/lib/docker/'

    - name: Restart Docker ğŸ”„
      run: sudo service docker restart

    - name: Check Disk After Cleanup ğŸ“¦âœ…
      run: |
        echo "âœ¨ Cleanup done!"
        df -hT

    - name: Install jq for JSON parsing ğŸ”§
      run: sudo apt-get update && sudo apt-get install -y jq curl

    - name: Checkout Code ğŸ›’
      uses: actions/checkout@v4

    - name: Setup Docker Buildx ğŸ”§
      uses: docker/setup-buildx-action@v3

    - name: Pull, Tag, Push Images ğŸ“¦â¡ï¸ğŸ›³ï¸
      run: |
        set -euo pipefail

        ALIYUN_REGISTRY="${{ env.ALIYUN_REGISTRY }}"
        ALIYUN_NAME_SPACE="${{ env.ALIYUN_NAME_SPACE }}"
        ALIYUN_REGISTRY_USER="${{ env.ALIYUN_REGISTRY_USER }}"
        ALIYUN_REGISTRY_PASSWORD="${{ env.ALIYUN_REGISTRY_PASSWORD }}"

        echo "ğŸ”‘ Login to Aliyun Registry..."
        docker login -u "$ALIYUN_REGISTRY_USER" -p "$ALIYUN_REGISTRY_PASSWORD" "$ALIYUN_REGISTRY"

        # å‡½æ•°ï¼šè°ƒç”¨ Docker Hub API è·å–æœ€æ–°ç‰ˆæœ¬tag
        get_latest_tag() {
          local repo=$1
          latest_tag=$(curl -s "https://registry.hub.docker.com/v2/repositories/${repo}/tags?page_size=100" | \
            jq -r '.results[].name' | grep -E '^[0-9]+(\.[0-9]+)*$' | sort -V | tail -1)

          if [ -z "$latest_tag" ]; then
            latest_tag="latest"
          fi
          echo "$latest_tag"
        }

        # è¯»å– images.txtï¼Œåˆ†ææ˜¯å¦æœ‰åŒåé•œåƒï¼Œé¿å…å‘½åå†²çª
        declare -A duplicate_images temp_map
        while IFS= read -r line || [ -n "$line" ]; do
          [[ -z "$line" || "$line" =~ ^# ]] && continue
          alias=$(echo "$line" | sed -n 's/.*--alias[ =]\([^ ]*\).*/\1/p')
          image=$(echo "$line" | sed -E 's/--alias[ =][^ ]+//g' | xargs | awk '{print $NF}')
          image="${image%%@*}"
          image_name=$(basename "$image" | cut -d':' -f1)
          name_space=$(echo "$image" | awk -F'/' '{print (NF==3 ? $2 : (NF==2 ? $1 : ""))}')
          if [ -n "${temp_map[$image_name]:-}" ] && [ "${temp_map[$image_name]}" != "${name_space}_" ]; then
            duplicate_images["$image_name"]=true
          fi
          temp_map["$image_name"]="${name_space}_"
        done < images.txt

        echo "ğŸš€ Start processing images..."

        while IFS= read -r line || [ -n "$line" ]; do
          [[ -z "$line" || "$line" =~ ^# ]] && continue

          alias=$(echo "$line" | sed -n 's/.*--alias[ =]\([^ ]*\).*/\1/p')
          platform=$(echo "$line" | awk -F'--platform[ =]' '{if (NF>1) print $2}' | awk '{print $1}')
          platform_prefix=${platform//\//_}_

          [ -z "$platform" ] && platform_prefix=""

          image=$(echo "$line" | sed -E 's/--alias[ =][^ ]+//g' | xargs | awk '{print $NF}')
          image="${image%%@*}"

          image_name_tag=$(basename "$image")
          image_name=$(echo "$image_name_tag" | cut -d':' -f1)
          image_tag=$(echo "$image_name_tag" | cut -d':' -f2)
          [ -z "$image_tag" ] && image_tag="latest"

          name_space=$(echo "$image" | awk -F'/' '{print (NF==3 ? $2 : (NF==2 ? $1 : ""))}')
          name_space_prefix=""
          if [ -n "${duplicate_images[$image_name]:-}" ] && [ -n "$name_space" ]; then
            name_space_prefix="${name_space}_"
          fi

          repo=$(echo "$image" | awk -F':' '{print $1}')

          # å¤„ç†éœ€è¦æ‹‰å–çš„æ ‡ç­¾åˆ—è¡¨
          tags_to_pull=()

          if [ "$image_tag" == "latest" ]; then
            tags_to_pull+=("latest")

            if [[ "$repo" == */* ]]; then
              latest_tag=$(get_latest_tag "$repo")
              if [ "$latest_tag" != "latest" ] && [ "$latest_tag" != "" ]; then
                tags_to_pull+=("$latest_tag")
                echo "ğŸ¯ For $repo, also pull latest version tag: $latest_tag"
              fi
            fi
          else
            tags_to_pull+=("$image_tag")
          fi

          for tag in "${tags_to_pull[@]}"; do
            image_name_tag="${image_name}:${tag}"

            # å¦‚æœæ˜¯ alias ä¸”ä¸æ˜¯ latest æ ‡ç­¾ï¼Œæ”¹ç”¨ alias æ ‡ç­¾å‘½å
            if [ -n "$alias" ] && [ "$tag" != "latest" ]; then
              image_name_tag="${alias}:${tag}"
            fi

            new_image="$ALIYUN_REGISTRY/$ALIYUN_NAME_SPACE/$platform_prefix$name_space_prefix$image_name_tag"

            echo "ğŸ³ Pulling $repo:$tag ..."
            docker pull "$repo:$tag"

            echo "ğŸ”— Tagging as $new_image ..."
            docker tag "$repo:$tag" "$new_image"

            echo "ğŸ“¤ Pushing $new_image ..."
            docker push "$new_image"

            echo "ğŸ§¹ Cleaning up local images..."
            docker rmi "$repo:$tag" "$new_image"

            echo "ğŸ›¢ï¸ Disk usage after cleanup:"
            df -hT
            echo "=============================================================================="
          done

        done < images.txt
