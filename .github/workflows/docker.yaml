name: Docker Pusher ðŸ³âœ¨

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

env:
  ALIYUN_REGISTRY: "${{ secrets.ALIYUN_REGISTRY }}"
  ALIYUN_NAME_SPACE: "${{ secrets.ALIYUN_NAME_SPACE }}"
  ALIYUN_REGISTRY_USER: "${{ secrets.ALIYUN_REGISTRY_USER }}"
  ALIYUN_REGISTRY_PASSWORD: "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Maximize Disk Space ðŸ“¦
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 2048
          swap-size-mb: 128
          remove-dotnet: true
          remove-haskell: true
          build-mount-path: "/var/lib/docker/"

      - name: Restart Docker ðŸ”„
        run: sudo service docker restart

      - name: Checkout Code ðŸ›’
        uses: actions/checkout@v4

      - name: Install Tools ðŸ”§
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq moreutils parallel

      - name: Login to Aliyun Docker ðŸ³
        run: docker login -u "${ALIYUN_REGISTRY_USER}" -p "${ALIYUN_REGISTRY_PASSWORD}" "${ALIYUN_REGISTRY}"

      - name: Sync Docker Images ðŸš€
        run: |
          set -euo pipefail

          export ALIYUN_REGISTRY="${ALIYUN_REGISTRY}"
          export ALIYUN_NAME_SPACE="${ALIYUN_NAME_SPACE}"
          WORKDIR=$(mktemp -d)
          IMAGE_LIST="${WORKDIR}/final_image_list.txt"

          get_dockerhub_recent_tags() {
            local repo="$1"
            local page=1
            local tags=()
            local cutoff_ts=$(date -d '1 day ago' +%s)

            while :; do
              url="https://registry.hub.docker.com/v2/repositories/${repo}/tags?page_size=100&page=$page"
              result=$(curl -fsSL "$url" || break)
              [[ -z "$result" || "$result" == "null" ]] && break

              tag_lines=$(echo "$result" | jq -r '.results[] | [.name, .last_updated] | @tsv')
              has_recent=false

              while IFS=$'\t' read -r tag updated; do
                ts=$(date -d "$updated" +%s 2>/dev/null || echo 0)
                if (( ts >= cutoff_ts )); then
                  if [[ "$tag" =~ ^(latest|bookworm|bullseye|alpine)$ || "$tag" =~ ^v?[0-9]+(\.[0-9]+){0,2}([-a-zA-Z0-9]+)?$ ]]; then
                    if [[ "$tag" =~ (alpha|beta|rc|dev|test|debug|nightly|canary|edge|amazon) && "$tag" != "latest" ]]; then
                      continue
                    fi
                    tags+=("$tag")
                    has_recent=true
                  fi
                fi
              done <<< "$tag_lines"

              [[ "$has_recent" == false ]] && break
              next=$(echo "$result" | jq -r '.next')
              [[ "$next" == "null" || -z "$next" ]] && break
              ((page++))
            done

            declare -A tags_by_major=()
            for t in "${tags[@]}"; do
              norm=$(echo "$t" | sed -E 's/^v//')
              if [[ "$norm" =~ ^([0-9]+)(\.[0-9]+)?(\.[0-9]+)?([-a-zA-Z0-9]+)?$ ]]; then
                major="${BASH_REMATCH[1]}"
                tags_by_major["$major"]+="$t "
              fi
            done

            declare -A final_keep=()
            for major in "${!tags_by_major[@]}"; do
              all_tags=(${tags_by_major[$major]})
              latest_tags=$(printf "%s\n" "${all_tags[@]}" | sort -Vr | head -n 3)
              while IFS= read -r line; do
                final_keep["$line"]=1
              done <<< "$latest_tags"
              if printf "%s\n" "${all_tags[@]}" | grep -qx "$major"; then
                final_keep["$major"]=1
              fi
            done

            if printf "%s\n" "${tags[@]}" | grep -q "^latest$"; then
              final_keep["latest"]=1
            fi

            printf "%s\n" "${!final_keep[@]}" | sort
          }

          get_ghcr_recent_tags() {
            local full_name="$1"
            local page=1
            local tags=()
            local cutoff_ts=$(date -d '2 days ago' +%s)

            while :; do
              url="https://ghcr.io/v2/${full_name}/tags/list?page_size=100&page=$page"
              result=$(curl -fsSL -H "Accept: application/vnd.oci.image.index.v1+json" "$url" || break)
              [[ -z "$result" || "$result" == "null" || "$result" == "{}" ]] && break

              tag_lines=$(echo "$result" | jq -r '.tags[]? // empty')
              [[ -z "$tag_lines" ]] && break

              while IFS= read -r tag; do
                if [[ "$tag" =~ ^(latest|main|master|develop|bookworm|bullseye|alpine)$ || "$tag" =~ ^v?[0-9]+(\.[0-9]+){0,2}([-a-zA-Z0-9]+)?$ ]]; then
                  if [[ "$tag" =~ (alpha|beta|rc|dev|test|debug|nightly|canary|edge|amazon) && "$tag" != "latest" ]]; then
                    continue
                  fi
                  tags+=("$tag")
                fi
              done <<< "$tag_lines"

              ((page++))
              if [[ $page -gt 1 ]]; then
                break
              fi
            done

            declare -A tags_by_major=()
            for t in "${tags[@]}"; do
              norm=$(echo "$t" | sed -E 's/^v//')
              if [[ "$norm" =~ ^([0-9]+)(\.[0-9]+)?(\.[0-9]+)?([-a-zA-Z0-9]+)?$ ]]; then
                major="${BASH_REMATCH[1]}"
                tags_by_major["$major"]+="$t "
              fi
            done

            declare -A final_keep=()
            for major in "${!tags_by_major[@]}"; do
              all_tags=(${tags_by_major[$major]})
              latest_tags=$(printf "%s\n" "${all_tags[@]}" | sort -Vr | head -n 3)
              while IFS= read -r line; do
                final_keep["$line"]=1
              done <<< "$latest_tags"
              if printf "%s\n" "${all_tags[@]}" | grep -qx "$major"; then
                final_keep["$major"]=1
              fi
            done

            if printf "%s\n" "${tags[@]}" | grep -q "^latest$"; then
              final_keep["latest"]=1
            fi

            printf "%s\n" "${!final_keep[@]}" | sort
          }

          generate_list() {
            local line="$(echo "$1" | xargs)"
            [[ -z "$line" || "$line" =~ ^# ]] && return

            alias=$(echo "$line" | sed -n 's/.*--alias[ =]\([^ ]*\).*/\1/p')
            image=$(echo "$line" | sed -E 's/--alias[ =][^ ]+//g' | awk '{print $NF}' | xargs)
            
            if [[ "$image" == *:* ]]; then
              base="${image%%:*}"
              tag="${image##*:}"
            else
              base="$image"
              tag=""
            fi

            if [[ "$image" =~ ^ghcr\.io/ ]]; then
              repo="${image#ghcr.io/}"
              name="$(echo "$base" | awk -F/ '{print $NF}')"
              [[ -n "$alias" ]] && target_name="$alias" || target_name="$name"

              if [[ -n "$tag" ]]; then
                echo "${base}:${tag} ${ALIYUN_REGISTRY}/${ALIYUN_NAME_SPACE}/${target_name}:${tag}" >> "$IMAGE_LIST"
              else
                tags=($(get_ghcr_recent_tags "$repo"))
                for t in "${tags[@]}"; do
                  echo "${base}:${t} ${ALIYUN_REGISTRY}/${ALIYUN_NAME_SPACE}/${target_name}:${t}" >> "$IMAGE_LIST"
                done
              fi
            else
              repo="${base}"
              [[ "$repo" != */* ]] && repo="library/$repo"
              name="$(echo "$base" | awk -F/ '{print $NF}')"
              [[ -n "$alias" ]] && target_name="$alias" || target_name="$name"
              if [[ -n "$tag" ]]; then
                echo "${base}:${tag} ${ALIYUN_REGISTRY}/${ALIYUN_NAME_SPACE}/${target_name}:${tag}" >> "$IMAGE_LIST"
              else
                tags=($(get_dockerhub_recent_tags "$repo"))
                for t in "${tags[@]}"; do
                  echo "${base}:${t} ${ALIYUN_REGISTRY}/${ALIYUN_NAME_SPACE}/${target_name}:${t}" >> "$IMAGE_LIST"
                done
              fi
            fi
          }

          echo "ðŸ“¦ Generating image list from images.txt..."
          > "$IMAGE_LIST"
          while IFS= read -r line; do
            generate_list "$line"
          done < images.txt

          echo "ðŸ“ $(wc -l < "$IMAGE_LIST") images to sync:"
          cat "$IMAGE_LIST"

          sync_one() {
            local src="$1"
            local target="$2"

            echo "ðŸ³ Pulling $src..."
            if ! docker pull "$src"; then
              echo "âŒ Failed to pull $src"
              return
            fi

            src_digest=$(docker inspect --format='{{index .RepoDigests 0}}' "$src" 2>/dev/null | cut -d@ -f2)
            target_digest=$(docker manifest inspect "$target" 2>/dev/null | jq -r '.manifests[0].digest // .config.digest' 2>/dev/null || true)

            if [[ -n "$src_digest" && "$src_digest" == "$target_digest" ]]; then
              echo "âœ… $target is up-to-date, skipping."
              docker rmi "$src" || true
              return
            fi

            echo "ðŸ”— Tagging $src -> $target"
            docker tag "$src" "$target"

            echo "ðŸ“¤ Pushing $target..."
            if ! timeout --foreground 300 docker push "$target"; then
              echo "âš ï¸ Push failed: $target"
              return
            fi

            docker rmi "$src" "$target" || true
            echo "âœ… Done: $src -> $target"
            echo "-------------------------------------------"
          }

          export -f sync_one
          cat "$IMAGE_LIST" | parallel -j 4 --colsep ' ' --line-buffer sync_one {1} {2}